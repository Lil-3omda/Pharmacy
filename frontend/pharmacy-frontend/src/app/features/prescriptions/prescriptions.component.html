<div class="prescriptions-container">
  <div class="container">
    <div class="page-header">
      <h1>الوصفات الطبية</h1>
      <p>ارفع وصفتك الطبية واحصل على الأدوية المطلوبة</p>
      <button mat-raised-button color="primary" (click)="openUploadDialog()">
        <mat-icon>cloud_upload</mat-icon>
        رفع وصفة طبية
      </button>
    </div>

    <!-- Upload Dialog -->
    <mat-card *ngIf="showUploadForm" class="upload-card">
      <mat-card-header>
        <mat-card-title>رفع وصفة طبية جديدة</mat-card-title>
        <button mat-icon-button (click)="closeUploadDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="uploadForm" (ngSubmit)="uploadPrescription()">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>اسم الطبيب</mat-label>
              <input matInput formControlName="doctorName" placeholder="أدخل اسم الطبيب">
              <mat-error *ngIf="uploadForm.get('doctorName')?.hasError('required')">
                اسم الطبيب مطلوب
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>تاريخ الوصفة</mat-label>
              <input matInput formControlName="prescriptionDate" type="date">
              <mat-error *ngIf="uploadForm.get('prescriptionDate')?.hasError('required')">
                تاريخ الوصفة مطلوب
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <div class="file-upload-area" (click)="fileInput.click()">
              <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden>
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <p>انقر لرفع صورة الوصفة الطبية</p>
              <small>PNG, JPG, JPEG (حد أقصى 5MB)</small>
            </div>
          </div>

          <div class="form-row" *ngIf="selectedFile">
            <div class="file-preview">
              <img [src]="previewUrl" alt="معاينة الوصفة">
              <button mat-icon-button color="warn" (click)="removeFile()">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="closeUploadDialog()">إلغاء</button>
            <button 
              mat-raised-button 
              color="primary" 
              type="submit"
              [disabled]="uploadForm.invalid || !selectedFile || isUploading">
              <mat-spinner *ngIf="isUploading" diameter="20"></mat-spinner>
              <span *ngIf="!isUploading">رفع الوصفة</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Prescriptions List -->
    <div class="prescriptions-list">
      <div *ngIf="isLoading" class="loading-container">
        <app-loading-spinner message="جاري تحميل الوصفات..."></app-loading-spinner>
      </div>

      <div *ngIf="!isLoading && prescriptions.length === 0" class="no-prescriptions">
        <mat-icon class="no-prescriptions-icon">description</mat-icon>
        <h3>لا توجد وصفات طبية</h3>
        <p>لم تقم برفع أي وصفات طبية بعد</p>
      </div>

      <mat-card *ngFor="let prescription of prescriptions" class="prescription-card">
        <mat-card-header>
          <div class="prescription-header">
            <div class="prescription-info">
              <h3>وصفة طبية #{{prescription.id}}</h3>
              <p>د. {{prescription.doctorName}}</p>
              <small>{{prescription.prescriptionDate | date:'dd/MM/yyyy'}}</small>
            </div>
            <mat-chip [class]="getStatusClass(prescription.status)">
              {{getStatusLabel(prescription.status)}}
            </mat-chip>
          </div>
        </mat-card-header>

        <mat-card-content>
          <div class="prescription-content">
            <div class="prescription-image">
              <img [src]="prescription.imageUrl" [alt]="'وصفة طبية ' + prescription.id">
            </div>
            
            <div class="prescription-details">
              <div *ngIf="prescription.medicines.length > 0" class="medicines-list">
                <h4>الأدوية المطلوبة:</h4>
                <div *ngFor="let medicine of prescription.medicines" class="medicine-item">
                  <span class="medicine-name">{{medicine.medicineName}}</span>
                  <span class="medicine-dosage">{{medicine.dosage}}</span>
                  <span class="medicine-duration">{{medicine.duration}}</span>
                </div>
              </div>
              
              <div *ngIf="prescription.notes" class="prescription-notes">
                <h4>ملاحظات:</h4>
                <p>{{prescription.notes}}</p>
              </div>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-button color="primary" *ngIf="prescription.status === 'Approved'">
            <mat-icon>shopping_cart</mat-icon>
            طلب الأدوية
          </button>
          <button mat-button>
            <mat-icon>download</mat-icon>
            تحميل
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>